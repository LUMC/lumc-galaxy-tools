<tool id="gatk4_genotype_gvcfs" name="GATK4 GenotypeGVCFs" version="@WRAPPER_VERSION@+galaxy1" profile="18.05">
    <description>- Perform joint genotyping on one or more samples pre-called with HaplotypeCaller</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_cmd"/>
    <command detect_errors="exit_code">
        <![CDATA[
        #include source=$set_sections#
        #include source=$pre_gatk_excl_ints_chth#
        #include source=$pre_gatk_ints_chth#

        #set ref_flag='--reference="reference.fa"'

        #if str($reference_source.reference_source_selector) == 'history'
            ln -s '$reference_source.reference_sequence' reference.fa &&
            samtools faidx reference.fa &&
            samtools dict reference.fa -o reference.dict &&
        #else if str($reference_source.reference_source_selector) == 'cached'
            ln -s '$reference_source.reference_sequence.fields.path' reference.fa &&
            samtools faidx reference.fa &&
            samtools dict reference.fa -o reference.dict &&
        #else
            #set ref_flag=''
        #end if

        ln -s $gvcf input.g.vcf.gz &&
        tabix -p vcf input.g.vcf.gz &&

        gatk GenotypeGVCFs --QUIET $ref_flag
            --variant=input.g.vcf.gz
        #if $advanced.disable_tool_default_annotations:
            --disable-tool-default-annotations
        #end if
        #if $optional.interval_merging_rule:
            --interval-merging-rule="$optional.interval_merging_rule"
        #end if

        #if $optional.interval_set_rule:
            --interval-set-rule="$optional.interval_set_rule"
        #end if

        #include source=$gatk_excl_ints_chth#
        #include source=$gatk_ints_chth#
        #include source=$vcf_output_opts#
        #include source=$gatk_seqdict#
        ]]>
    </command>
    <inputs>
        <param name="gvcf" label="GVCF file" type="data" format="vcf_bgzip"/>
        <expand macro="ref_sel"/>
        <expand macro="gzip_vcf_params"/>
        <section name="optional" title="Interval options" expanded="false">

                <expand macro="gatk_excl_ints"/>
                <expand macro="gatk_ints"/>

                <param name="interval_merging_rule" argument="--interval-merging-rule" type="select" optional="true" label="Interval Merging Rule" help="Interval merging rule for abutting intervals">
                    <option selected="true" value="ALL">All</option>
                    <option value="OVERLAPPING_ONLY">Overlapping only</option>
                </param>
                <param name="interval_set_rule" argument="--interval-set-rule" type="select" optional="true" label="Interval Set Rule" help="Set merging approach to use for combining interval inputs">
                    <option selected="true" value="UNION">Union</option>
                    <option value="INTERSECTION">Intersection</option>
                </param>
        </section>
        <section name="advanced" title="Advanced options">
            <param name="disable_tool_default_annotations"
                   label="Disable tool default annotations"
                   argument="--disable-tool-default-annotations"
                   type="boolean"/>
        </section>
    </inputs>
    <outputs>
        <expand macro="gzip_vcf_output_params"/>
    </outputs>
    <help><![CDATA[Perform joint genotyping on one or more samples pre-called
with HaplotypeCaller

This tool is designed to perform joint genotyping on a single input, which may
contain one or many samples. In any case, the input samples must possess
genotype likelihoods produced by HaplotypeCaller with `-ERC GVCF` or
`-ERC BP_RESOLUTION`.

Input
~~~~~

The GATK4 GenotypeGVCFs tool can take only one input track. Options are 1) a
single single-sample GVCF 2) a single multi-sample GVCF created by CombineGVCFs
or 3) a GenomicsDB workspace created by GenomicsDBImport. A sample-level GVCF
is produced by HaplotypeCaller with the `-ERC GVCF` setting.

Output
~~~~~~
A final VCF in which all samples have been jointly genotyped.

Usage example
~~~~~~~~~~~~~~
::

    gatk --java-options "-Xmx4g" GenotypeGVCFs \
        -R Homo_sapiens_assembly38.fasta \
        -V input.g.vcf.gz \
        -O output.vcf.gz


Caveats
~~~~~~~

+ Only GVCF files produced by HaplotypeCaller (or CombineGVCFs) can be used as
  input for this tool. Some other programs produce files that they call GVCFs
  but those lack some important information (accurate genotype likelihoods for
  every position) that GenotypeGVCFs requires for its operation.

+ Cannot take multiple GVCF files in one command.

+ The amount of temporary disk storage required by GenomicsDBImport may exceed
  what is available in the default location: `/tmp`. The command line argument
  `--tmp-dir` can be used to specify an alternate temperary storage location
  with sufficient space.

]]></help>
    <citations>
        <expand macro="citations"/>
    </citations>
</tool>
